function snippet_preloadImages(e,t){var n={};for(var a in e)!function(){var t=new Image,i=a;t.onload=function(){n[e[i]]=t},t.src=e[a]}();var i=setInterval(function(){var r=0;for(a in n)r++;r==e.length&&(t(n),clearInterval(i))},500)}function snippet_evt_off(e,t,n){e.removeEventListener?e.removeEventListener(t,n):e.detachEvent&&e.detachEvent("on"+t,n)}function snippet_evt_on(e,t,n){function a(e){var t=n.apply(this,arguments);return t===!1&&(e.stopPropagation(),e.preventDefault()),t}function i(){var t=n.call(e,window.event);return t===!1&&(window.event.returnValue=!1,window.event.cancelBubble=!0),t}return e.addEventListener?(e.addEventListener(t,a,!1),a):(e.attachEvent("on"+t,i),i)}function snippet_scale_restrictW(e,t,n){var a={w:e,h:t};return e>n&&(a.w=n,a.h=a.w*t/e),a}function snippet_scale_restrictH(e,t,n){var a={w:e,h:t};return t>n&&(a.h=n,a.w=a.h*e/t),a}function snippet_scale_restrictAuto(e,t,n,a){var i=null;if(e>=t){if(e>n)return i=snippet_scale_restrictW(e,t,n),snippet_scale_restrictH(i.w,i.h,a)}else if(t>a)return i=snippet_scale_restrictH(e,t,a),snippet_scale_restrictW(i.w,i.h,n)}function snippet_date_diference(e,t){var n=e.getTime(),a=t.getTime();return snippet_date_milli_diference(n,a)}function snippet_date_milli_diference(e,t){var n=Math.abs(t-e);return days=Math.floor(n/864e5),daysms=n%864e5,hours=Math.floor(daysms/36e5),hoursms=n%36e5,minutes=Math.floor(hoursms/6e4),minutesms=n%6e4,sec=Math.floor(minutesms/1e3),{d:days,h:hours,m:minutes,s:sec}}function snippet_url_exist(e,t){function n(){if(4===a.readyState){if(200!=a.status&&0!=a.status)return void t(!1);t(!0)}}var a=new XMLHttpRequest,i=e;a.open("get",i,!0),a.onreadystatechange=n,a.send(null)}$z={grid:{draw:function(e){e._xW=e._xW||0,e._xH=e._xH||0;var t=e.canvas.getContext("2d"),n=0,a=e.canvas.width,i=e.canvas.height,r=e.divisions;t.beginPath();var o=a/(a/r)+.5|0;for(e._xW=a/o,n=0;a>=n;n+=e._xW)t.moveTo(n,0),t.lineTo(n,i);for(o=i/(i/r)+.5|0,e._xH=i/o,n=0;i>=n;n+=e._xH)t.moveTo(0,n),t.lineTo(a,n);return t.strokeStyle=e.gridStrokeStyle,e._ctx.lineWidth=e.gridLineWidth,t.stroke(),function(){var t=$z._getCurrentImage(e),n=e._xW,a=e._xH;for(var i in e.imagesInMemoryData[t.index].zoomData)i>0&&(n/=e.divisions,a/=e.divisions);e.imagesInMemoryData[t.index].zoomData[e.imagesInMemoryData[t.index].index].xw=n,e.imagesInMemoryData[t.index].zoomData[e.imagesInMemoryData[t.index].index].xh=a}(),this},point:function(e,t,n){return{x:e*n._xW-n._xW/2,y:t*n._xH-n._xH/2}},advancePoint:function(e,t,n,a){return{x:e*n-n/2,y:t*a-a/2}}},_createSelector:function(e,t){var n=this,a={};return a.moveH=function(n){var a=e._selectorX+n;0>=a||a>e.divisions||(e._selectorX=a,t.update())},a.moveY=function(n){var a=e._selectorY+n;0>=a||a>e.divisions||(e._selectorY=a,t.update())},a.draw=function(){var t=n.grid.point(e._selectorX,e._selectorY,e);e._ctx.beginPath(),e._ctx.rect(t.x-e._xW/2,t.y-e._xH/2,e._xW,e._xH),e._ctx.fillStyle=e.selectorFillStyle,e._ctx.fill(),e._ctx.lineWidth=e.selectorLineWidth,e._ctx.strokeStyle=e.selectorStrokeStyle,e._ctx.stroke()},a},_setDefaults:function(e){e.loadingIconUrl=e.loadingIconUrl||"loading.jpg",e.canvasId=e.canvasId||null,e.fullscreen=e.fullscreen||!1,e.divisions=e.divisions||5,e.gridStrokeStyle=e.gridStrokeStyle||"rgba(255, 255, 255, 1)",e.gridLineWidth=e.gridLineWidth||2,e.selectorFillStyle=e.selectorFillStyle||"rgba(255,255,255,0.5)",e.selectorStrokeStyle=e.selectorStrokeStyle||"white",e.selectorLineWidth=e.selectorLineWidth||2,e.index=e.index||0,e.imagesInMemory=null,e.canvas=null!==e.canvasId?document.getElementById(e.canvasId):document.getElementsByTagName("canvas")[0],e._ctx=e.canvas.getContext("2d"),e._selectorX=e._selectorX||1,e._selectorY=e._selectorY||1,e._xW=e._xW||0,e._xH=e._xH||0},_createFullscreenFn:function(e,t){var n=snippet_evt_on(window,"resize",function(){if(!t.isFullscreen){var n=Math.max(document.documentElement.clientWidth,window.innerWidth||0),a=Math.max(document.documentElement.clientHeight,window.innerHeight||0);e.canvas.setAttribute("width",n),e.canvas.setAttribute("height",a)}e.canvas.dispatchEvent(new Event("viewer_update"))});return n},_rescaleCanvasProportionally:function(e,t){var n=snippet_scale_restrictAuto(e.width,e.height,window.innerWidth,window.innerHeight);t.canvas.setAttribute("width",n.w),t.canvas.setAttribute("height",n.h)},_createImageViewerData:function(e,t){var n={zoomData:[],index:0};return n.zoomData.push({xw:e._xW,xh:e._xH,sx:0,sy:0,rx:0,ry:0,sw:t.width,sh:t.height}),n._selectorY=e.divisions/2+.5|0,n._selectorX=e.divisions/2+.5|0,n},_getImageViewerZoomData:function(e,t){return{xw:e.zoomData[t].xw,xh:e.zoomData[t].xh,sx:e.zoomData[t].sx,sy:e.zoomData[t].sy,rx:e.zoomData[t].rx,ry:e.zoomData[t].ry,sw:e.zoomData[t].sw,sh:e.zoomData[t].sh}},_calculateGridBounds:function(e){var t={xw:0,xh:0};w=e.canvas.width,h=e.canvas.height,pw=e.divisions;var n=w/(w/pw)+.5|0;return t.xw=w/n,n=h/(h/pw)+.5|0,t.xh=h/n,t},_drawLoadingIcon:function(e){var t=this._calculateGridBounds(e),n=this.grid.advancePoint(e.divisions/2+.5|0,e.divisions/2+.5|0,t.xw,t.xh),a={x:n.x-t.xw/2,y:n.y-t.xh/2,w:t.xw,h:t.xh},i=e.loadingIconImage;e._ctx.drawImage(i,0,0,i.width,i.height,a.x,a.y,a.w,a.h),console.log("drawing icon at "+JSON.stringify(a))},_createUpdateFn:function(e,t){var n=this,a=snippet_evt_on(e.canvas,"viewer_update",function(){if(null!==e.imagesInMemory){var a=n._getCurrentImage(e),i=a.img;e.isFullscreen||n._rescaleCanvasProportionally(i,e),"undefined"==typeof e.imagesInMemoryData[a.index]&&(e.imagesInMemoryData[a.index]=n._createImageViewerData(e,i));var r=n._getImageViewerZoomData(e.imagesInMemoryData[a.index],e.imagesInMemoryData[a.index].index),o=(new Date).getTime();e._ctx.drawImage(i,r.rx,r.ry,r.sw,r.sh,0,0,e.canvas.width,e.canvas.height);{var s=(new Date).getTime();snippet_date_milli_diference(o,s)}t.isNegative&&!function(t,n){for(var a=n.getImageData(0,0,e.canvas.width,e.canvas.height),i=a.data,r=0;r<i.length;r+=4)i[r]=255-i[r],i[r+1]=255-i[r+1],i[r+2]=255-i[r+2];n.putImageData(a,0,0)}(i,e._ctx)}n.grid.draw(e),"undefined"!=typeof e._selector&&e._selector.draw(),e._nextZoomData=n._calculateNextZoomData(e);var c=new Event("viewer_update_end");c.p=e,e.canvas.dispatchEvent(c)});return a},_calculateNextZoomData:function(e){var t=this,n=t._getCurrentImage(e),a=e.imagesInMemoryData[n.index],i=t._getImageViewerZoomData(a,a.index),r=(t._getImageViewerZoomData(a,0),{x:i.xw*(e._selectorX-1)+i.sx,y:i.xh*(e._selectorY-1)+i.sy});r.rx=n.img.width*r.x/e.canvas.width,r.ry=n.img.height*r.y/e.canvas.height;var o={w:n.img.width*i.xw/e.canvas.width,h:n.img.height*i.xh/e.canvas.height},s={xw:i.xw/e.divisions,xh:i.xh/e.divisions,sx:r.x,sy:r.y,rx:r.rx,ry:r.ry,sw:o.w,sh:o.h};return s},_getCurrentImage:function(e){var t=0;for(var n in e.imagesInMemory){if(t==e.index)return{img:e.imagesInMemory[n],index:n};t++}return null},_zoomIn:function(e){var t=this,n=t._getCurrentImage(e);e.imagesInMemoryData[n.index].zoomData.push(e._nextZoomData),e.imagesInMemoryData[n.index].index=e.imagesInMemoryData[n.index].zoomData.length-1,e.canvas.dispatchEvent(new Event("viewer_update"))},_zoomOut:function(e){var t=this,n=t._getCurrentImage(e);e.imagesInMemoryData[n.index].zoomData.length>1&&(e.imagesInMemoryData[n.index].zoomData.pop(),e.imagesInMemoryData[n.index].index-=1,e.canvas.dispatchEvent(new Event("viewer_update")))},_bindKeyboard:function(e,t){var n=this;return snippet_evt_on(window,"keydown",function(a){var i=String.fromCharCode(a.keyCode).toUpperCase();if("undefined"!=typeof e._selector){if(37==a.keyCode)return void t.prev();if(39==a.keyCode)return void t.next();if(32==a.keyCode)return void n._zoomIn(e);if(79==a.keyCode)return void n._zoomOut(e);"N"==i&&t.toggleNegative(!t.isNegative),"A"==i?e._selector.moveH(-1):"D"==i&&e._selector.moveH(1),"W"==i?e._selector.moveY(-1):"S"==i&&e._selector.moveY(1)}})},create:function(e){function t(t){snippet_preloadImages([t],function(t){if(null==e.imagesInMemory)e.imagesInMemory=t,e.imagesInMemoryData={};else for(var n in t)e.imagesInMemory[n]=t[n];var a=0;for(var i in e.imagesInMemory)a++;e.imagesInMemoryLength=a,r++})}var n=this;n._setDefaults(e);var a={isFullscreen:!1,isNegative:!1};e._oriW=e.canvas.width,e._oriH=e.canvas.height,e._fnFullscreen=n._createFullscreenFn(e,a),a.update=n._createUpdateFn(e,a),e._selector=n._createSelector(e,a),e._fnUnbindKeyboard=n._bindKeyboard(e,a),a.toggleFullscreen=function(t){a.isFullscreen=t,t?e._fnFullscreen():(e.canvas.setAttribute("width",e._oriW),e.canvas.setAttribute("height",e._oriH),a.update())},a.toggleNegative=function(t){this.isNegative=t,e.canvas.dispatchEvent(new Event("viewer_update"))},e.fullscreen&&a.toggleFullscreen(!0),a.show=function(){e.canvas.style.display="inherit",a.update()},a.hide=function(){e.canvas.style.display="none"},a.next=function(){e.index+1<=e.imagesInMemoryLength-1&&(e.index+=1),e.canvas.dispatchEvent(new Event("viewer_update"))},a.prev=function(){e.index-1>=0&&(e.index-=1),e.canvas.dispatchEvent(new Event("viewer_update"))},a["goto"]=function(t){t-1>=0&&t-1<=e.imagesInMemoryLength-1&&(e.index=t-1),e.canvas.dispatchEvent(new Event("viewer_update"))},a.p=e;var i=e.images.length,r=0,o=setInterval(function(){r==i&&(clearInterval(o),e.callback(a))},500);for(var s in e.images)!function(){var n=e.images[s];snippet_url_exist(n,function(e){e?t(n):r++})}()}};